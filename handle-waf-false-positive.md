
いつもお世話になっております。Azure IaaS チームの庄です。
WAFの**誤検知**とは、WAFが正常なアクセスや無害なリクエストを誤って攻撃と判断し、不当にブロックすることを指します。こちらのブログは、WAFを利用する際に、誤検知が発生する際の対応方法につきまして障害いたします。

# 誤検知が発生する際に対応方法

## WAF側の設定

Azure WAF の設定を使って誤検知を避ける方法には、主に3つの方法があります。

 1. 除外を利用する
特定のヘッダーやリクエストボディ内で誤検知が起こった部分を指定し、これらを誤検知として検出されたルールの評価から外す方法となります。この方法は、本文に紹介した3つの中で最も安全性が高いと考えられます。

 2. カスタムルールを利用する
カスタムルールでは、特定のIPアドレスからの通信や特定のパスへのアクセスをWAFの評価から除外し、これらをBypassするカスタムルールを作成できます。カスタムルールはマネージドルールよりも優先されるため、ここで設定したルールにより通信が許可または拒否されます。

 3.  特定のルールの無効化
WAFが特定のルールに誤検知が発生した場合、そのルールを無効にすることも誤検知への対処法の一つです。

これらの方法以外にも、WAFの要求本文の検査を無効にすることが考えられますが、これを行うとWAFがリクエストボディを検査しなくなり、セキュリティリスクが高まる可能性があります。このオプションを検討する場合は、サーバー側でのセキュリティ対策の実装を検討していただくことをお勧めします。

## アプリ側の対応

WAF側の設定だけではご要件を満たさない場合、アプリケーション側で対策を講じることが解決策の一つとなります。例として、ユーザー情報をフォームで収集するアプリケーションを開発する際に、フォームの入力で「#」や「%」のような、SQL攻撃に利用され得る文字を使用することを制限する設定を追加することで、ユーザーがこれらの文字を含むリクエストに送るための誤検知を防ぐことができます。


# ログ
誤検知が発生した場合、その原因を理解することが最初のステップとなります。具体的には、どのルールによって誤検知が起きているのか、そしてその誤検知の原因は何なのかを把握する必要があります。この情報がなければ、誤検知を避けるための適切な対策を講じることができません。

WAFのログは、WAFに関連付けるApplication Gateway のログに確認ことが可能です。ルールをマッチした原因は、WAFログの「details_data_s」あるいは「details_message_s」に確認することが可能でございます。
「details_data_s」基本的は、以下の形式でマッチされたものを確認可能です。

## ①
①の部分は、基本的は、マッチされて文字列となります。例えば、リクエストディに「＃」が含むため、ルールより検出された際には、①には「＃」となります。

## ②
②の部分は、基本的は、リクエストボヂィーのどこの部分が、文字列が含むことが示す。例えば、あるヘッダー名の中に「＃」を含む際には、②の部分は、HeaderName というものが表示されます。あるヘッダー値の中に「＃」を含む際には、②の部分は、HeaderValueというものが表示されます。

## ③
このセクションが表示する内容は、上記②の部分との関連性があります。②が「xxxName」を持つ場合、③では、その特定のヘッダー名が表示されます。例として、ヘッダー名が「#header」となり、「#」が含まれているためにWAFによって検出された場合、③には「#header」が表示されることになります。

一方、上記②の部分では、「xxValue」が表示されている場合は、③では「 A ：B」という形で表示されます。Ｂには、検出された値の完全版、Ａは検出されたもの所在のヘッダー名前や要求本文フィールドの名前。例えば、「header」というヘッダーの値に、
ヘッダー名：Header
ヘッダー値：＃Value

Header : Value

Matched Data: **#** found within HeaderValue : **Header**: **#Value**

# 除外
除外を作成する際には、ログに検出された内容

「details_data_s」に値で検出された場合、以前ご案内した通り、WAFでは、値に特定の文字列を含む場合に除外することができない為、以下のような除外では、除外効果がございません。

ーーーーーーーー除外効果がないルールーーーーーーー
 
検知内容: Matched Data: **12** found within **ARGS** : **page**: **1234**
除外：
一致変数：要求引数値
演算子： 次の値に含む
セレクター： 12
 
検知内容: Matched Data: **1111** found within **ARGS** : **page**: **1111**
除外：
一致変数：要求引数値
演算子： 次の値に等しい
セレクター： 1111
ーーーーーーーーーーーーーーーーーーーーーーーー


## カスタムルール

You can rename the current file by clicking the file name in the navigation bar or by clicking the **Rename** button in the file explorer.

